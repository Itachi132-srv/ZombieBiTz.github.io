<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Zombie Bitz</title>
<style>
body{margin:0;overflow:hidden;font-family:sans-serif;background:#87ceeb;}
#overlay,#gameOverOverlay{
  position:absolute;top:0;left:0;width:100%;height:100%;background:#222;color:white;
  display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:20;
}
#overlay button,#gameOverOverlay button{font-size:20px;margin:10px;padding:10px 25px;}
#scoreBoard,#coinsBoard{
  position:absolute;z-index:10;font-size:20px;color:white;
}
#scoreBoard{top:10px;left:10px;}
#coinsBoard{top:10px;right:10px;color:yellow;}
#shopPanel{
  display:none;position:absolute;top:50px;right:10px;width:180px;height:250px;
  background:#333;color:white;padding:10px;z-index:10;overflow:auto;border-radius:10px;
}
button{padding:10px;margin:5px;font-size:16px;border:none;border-radius:5px;background:#555;color:white;}
#joystickContainer{position:absolute;bottom:20px;left:20px;width:100px;height:100px;z-index:10;}
#fireBtn,#jumpBtn,#grenadeBtn{
  position:absolute;width:60px;height:60px;border-radius:30px;background:red;opacity:0.7;z-index:10;font-size:18px;color:white;border:none;
}
#fireBtn{bottom:30px;right:20px;}
#jumpBtn{bottom:100px;right:20px;}
#grenadeBtn{bottom:170px;right:20px;}
</style>
</head>
<body>

<div id="overlay">
  <h1>Zombie Blitz Pro</h1>
  <button onclick="startGame()">Play</button>
  <button onclick="toggleShop()">Shop</button>
  <button onclick="quitGame()">Quit</button>
</div>

<div id="gameOverOverlay" style="display:none;">
  <h1>Game Over</h1>
  <p id="finalScore">Score: 0</p>
  <button onclick="restartGame()">Restart</button>
  <button onclick="backToMenu()">Main Menu</button>
</div>

<div id="scoreBoard">Score: 0</div>
<div id="coinsBoard">Coins: 0</div>

<div id="shopPanel">
  <h3>Shop</h3>
  <button onclick="buyGun('Pistol',0)">Pistol (Default)</button><br>
  <button onclick="buyGun('AK47',500)">AK47 - 500 Coins</button><br>
  <button onclick="buyGun('Shotgun',1000)">Shotgun - 1000 Coins</button>
</div>

<div id="joystickContainer"></div>
<button id="fireBtn">Fire</button>
<button id="jumpBtn">Jump</button>
<button id="grenadeBtn">Grenade</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

<script>
// ====== Basic setup ======
let scene,camera,renderer,controls;
let player={health:100,score:0,coins:0,gun:'Pistol'};
let zombies=[],bullets=[],grenades=[];
let gameStarted=false,wave=1;
let move={forward:0,right:0};
let gunMesh;

// Initialize scene
function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,1.6,5);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light=new THREE.DirectionalLight(0xffffff,1);
  light.position.set(0,50,50);
  scene.add(light);

  // Ground
  const groundMat=new THREE.MeshStandardMaterial({color:0x228B22});
  const groundGeo=new THREE.BoxGeometry(100,1,100);
  const ground=new THREE.Mesh(groundGeo,groundMat);
  ground.position.y=-0.5;
  scene.add(ground);

  // Obstacles
  for(let i=0;i<10;i++){
    const box=new THREE.Mesh(new THREE.BoxGeometry(3,3,3), new THREE.MeshStandardMaterial({color:0x8B4513}));
    box.position.set(Math.random()*40-20,1.5,Math.random()*40-20);
    scene.add(box);
  }

  // Player hand + gun
  gunMesh=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,1), new THREE.MeshStandardMaterial({color:0x000000}));
  gunMesh.position.set(0,-0.2,-0.5);
  camera.add(gunMesh);
  scene.add(camera);

  controls=new THREE.PointerLockControls(camera,document.body);
  document.addEventListener('click',()=>{if(gameStarted && !controls.isLocked) controls.lock();});

  // Zombies spawn
  setInterval(spawnZombie,2000);

  animate();
}

// Joystick
let joystick=nipplejs.create({zone:document.getElementById('joystickContainer'),mode:'static',position:{left:'50px',bottom:'50px'},size:100});
joystick.on('move',(evt,data)=>{move.forward=data.vector.y;move.right=data.vector.x;});
joystick.on('end',()=>{move.forward=0;move.right=0;});

// Buttons
document.getElementById('fireBtn').addEventListener('touchstart',shootBullet);
document.getElementById('jumpBtn').addEventListener('touchstart',()=>{camera.position.y+=1;});
document.getElementById('grenadeBtn').addEventListener('touchstart',throwGrenade);

// Spawn zombie
function spawnZombie(){
  if(!gameStarted) return;
  const z=new THREE.Mesh(new THREE.BoxGeometry(1,2,1),new THREE.MeshStandardMaterial({color:0xff0000}));
  z.position.set(Math.random()*50-25,1,Math.random()*50-25);
  z.health=50+wave*10;
  zombies.push(z);
  scene.add(z);
}

// Shoot
function shootBullet(){
  if(!gameStarted) return;
  const b=new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8),new THREE.MeshBasicMaterial({color:0xffff00}));
  b.position.copy(camera.position);
  b.direction=new THREE.Vector3();
  camera.getWorldDirection(b.direction);
  bullets.push(b);
  scene.add(b);
}

// Grenade
function throwGrenade(){
  if(!gameStarted) return;
  zombies.forEach(z=>{if(z.position.distanceTo(camera.position)<5) z.health=0;});
}

// Animate
function animate(){
  requestAnimationFrame(animate);
  if(gameStarted){
    controls.moveForward(move.forward*0.05*-1);
    controls.moveRight(move.right*0.05);

    // Zombies
    zombies.forEach((z,i)=>{
      const dir=new THREE.Vector3();
      dir.subVectors(camera.position,z.position).normalize();
      z.position.add(dir.multiplyScalar(0.02));
      if(z.position.distanceTo(camera.position)<1){player.health-=0.3;if(player.health<=0) gameOver();}
    });

    // Bullets
    bullets.forEach((b,i)=>{
      b.position.add(b.direction.clone().multiplyScalar(0.5));
      zombies.forEach((z,j)=>{
        if(b.position.distanceTo(z.position)<1){
          z.health-=50;scene.remove(b);bullets.splice(i,1);
          if(z.health<=0){player.score+=50;player.coins+=50;scene.remove(z);zombies.splice(j,1);}
        }
      });
    });

    document.getElementById('scoreBoard').innerText='Score: '+Math.floor(player.score);
    document.getElementById('coinsBoard').innerText='Coins: '+Math.floor(player.coins);
  }
  renderer.render(scene,camera);
}

// Game control
function startGame(){gameStarted=true;player.health=100;document.getElementById('overlay').style.display='none';}
function toggleShop(){const s=document.getElementById('shopPanel');s.style.display=s.style.display==='none'?'block':'none';}
function buyGun(name,price){if(player.coins>=price){player.coins-=price;player.gun=name;alert(name+' equipped!');}else alert('Not enough coins!');}
function quitGame(){alert('Thanks for playing!');window.location.reload();}
function restartGame(){document.getElementById('gameOverOverlay').style.display='none';player.health=100;player.score=0;player.coins=0;zombies.forEach(z=>scene.remove(z));zombies=[];gameStarted=true;}
function backToMenu(){document.getElementById('gameOverOverlay').style.display='none';document.getElementById('overlay').style.display='flex';player.health=100;player.score=0;player.coins=0;zombies.forEach(z=>scene.remove(z));zombies=[];gameStarted=false;}
function gameOver(){document.getElementById('finalScore').innerText='Score: '+Math.floor(player.score);document.getElementById('gameOverOverlay').style.display='flex';gameStarted=false;}

init();
</script>
</body>
</html>
